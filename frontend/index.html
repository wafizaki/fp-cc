<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tenant Manager - FileBrowser</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .create-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .create-form input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .create-form input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #10b981;
        color: white;
        font-size: 0.875rem;
        padding: 8px 16px;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
        font-size: 0.875rem;
        padding: 8px 16px;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
        font-size: 0.875rem;
        padding: 8px 16px;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .tenants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .tenant-card {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s;
      }

      .tenant-card:hover {
        border-color: #667eea;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
      }

      .tenant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .tenant-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-running {
        background: #d1fae5;
        color: #065f46;
      }

      .status-stopped {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-error {
        background: #fef3c7;
        color: #92400e;
      }

      .tenant-info {
        margin-bottom: 15px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
      }

      .info-label {
        color: #6b7280;
        font-weight: 500;
      }

      .info-value {
        color: #1f2937;
        font-weight: 600;
      }

      .credentials {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 6px;
        padding: 10px;
        margin: 10px 0;
        font-size: 0.875rem;
      }

      .credentials strong {
        color: #92400e;
      }

      .tenant-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ef4444;
      }

      .success-message {
        background: #d1fae5;
        color: #065f46;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #10b981;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
      }

      .pagination button {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }

      .pagination button:hover:not(:disabled) {
        background: #667eea;
        color: white;
      }

      .pagination button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
      }

      .empty-state svg {
        width: 120px;
        height: 120px;
        margin-bottom: 20px;
        opacity: 0.3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üóÇÔ∏è FileBrowser Tenant Manager 2.0</h1>
        <p>Create and manage isolated FileBrowser instances</p>
      </div>

      <div class="card">
        <h2 style="margin-bottom: 20px; color: #1f2937">Create New Tenant</h2>
        <div id="message"></div>
        <form class="create-form" id="createForm">
          <input
            type="text"
            id="tenantName"
            placeholder="Enter tenant name (e.g., company_abc)"
            pattern="[a-zA-Z0-9_]+"
            minlength="3"
            maxlength="50"
            required
          />
          <button type="submit" class="btn btn-primary" id="createBtn">
            Create Tenant
          </button>
        </form>
        <small style="color: #6b7280; margin-top: 10px; display: block">
          Tenant name must be 3-50 characters, alphanumeric and underscores only
        </small>
      </div>

      <div class="card">
        <h2 style="margin-bottom: 20px; color: #1f2937">Active Tenants</h2>
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Loading tenants...</p>
        </div>
        <div id="tenantsContainer" style="display: none">
          <div id="tenantsList" class="tenants-grid"></div>
          <div id="pagination" class="pagination"></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8081/api";
      let currentPage = 1;
      const perPage = 9;

      // Show message
      function showMessage(message, type = "error") {
        const messageDiv = document.getElementById("message");
        messageDiv.className =
          type === "error" ? "error-message" : "success-message";
        messageDiv.textContent = message;
        messageDiv.style.display = "block";
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 5000);
      }

      // Format date
      function formatDate(dateString) {
        return new Date(dateString).toLocaleString();
      }

      // Get status class
      function getStatusClass(status) {
        const statusMap = {
          running: "status-running",
          stopped: "status-stopped",
          error: "status-error",
        };
        return statusMap[status] || "status-error";
      }

      // Create tenant card
      function createTenantCard(tenant) {
        return `
                <div class="tenant-card">
                    <div class="tenant-header">
                        <div class="tenant-name">${tenant.name}</div>
                        <span class="status-badge ${getStatusClass(
                          tenant.status
                        )}">
                            ${tenant.status}
                        </span>
                    </div>

                    <div class="tenant-info">
                        <div class="info-row">
                            <span class="info-label">Port</span>
                            <span class="info-value">${tenant.port}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">URL</span>
                            <span class="info-value">
                                <a href="${
                                  tenant.url
                                }" target="_blank" style="color: #667eea; text-decoration: none;">
                                    ${tenant.url}
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Created</span>
                            <span class="info-value">${formatDate(
                              tenant.created_at
                            )}</span>
                        </div>
                    </div>

                    ${
                      tenant.password
                        ? `
                        <div class="credentials">
                            <strong>Initial Credentials:</strong><br>
                            Username: <code>${tenant.username}</code><br>
                            Password: <code>${tenant.password}</code>
                        </div>
                    `
                        : ""
                    }

                    <div class="tenant-actions">
                        <a href="${
                          tenant.url
                        }" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                            Open FileBrowser
                        </a>
                        ${
                          tenant.status === "running"
                            ? `
                            <button class="btn btn-warning" onclick="stopTenant('${tenant.name}')">
                                Stop
                            </button>
                        `
                            : `
                            <button class="btn btn-success" onclick="startTenant('${tenant.name}')">
                                Start
                            </button>
                        `
                        }
                        <button class="btn btn-danger" onclick="deleteTenant('${
                          tenant.name
                        }')">
                            Delete
                        </button>
                    </div>
                </div>
            `;
      }

      // Load tenants
      async function loadTenants(page = 1) {
        try {
          document.getElementById("loading").style.display = "block";
          document.getElementById("tenantsContainer").style.display = "none";

          const response = await fetch(
            `${API_BASE}/tenants?page=${page}&per_page=${perPage}`
          );
          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          const tenantsList = document.getElementById("tenantsList");
          const pagination = document.getElementById("pagination");

          if (result.data.length === 0) {
            tenantsList.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <h3>No tenants yet</h3>
                            <p>Create your first tenant to get started</p>
                        </div>
                    `;
          } else {
            // Fetch detail for each tenant to get username and password
            const tenantsWithDetails = await Promise.all(
              result.data.map(async (tenant) => {
                try {
                  const detailResponse = await fetch(
                    `${API_BASE}/tenants/${tenant.name}`
                  );
                  const detailResult = await detailResponse.json();

                  if (detailResult.success && detailResult.data) {
                    // Merge detail data (username, password) with original tenant data
                    return {
                      ...tenant,
                      username: detailResult.data.username,
                      password: detailResult.data.password,
                    };
                  }
                  return tenant;
                } catch (error) {
                  console.error(
                    `Error loading details for ${tenant.name}:`,
                    error
                  );
                  return tenant;
                }
              })
            );

            tenantsList.innerHTML = tenantsWithDetails
              .map(createTenantCard)
              .join("");
          }

          // Pagination
          const meta = result.meta;
          pagination.innerHTML = `
                    <button onclick="loadTenants(${page - 1})" ${
            page <= 1 ? "disabled" : ""
          }>
                        Previous
                    </button>
                    <span style="padding: 8px 16px; color: #667eea; font-weight: 600;">
                        Page ${meta.page} of ${meta.max_page}
                    </span>
                    <button onclick="loadTenants(${page + 1})" ${
            page >= meta.max_page ? "disabled" : ""
          }>
                        Next
                    </button>
                `;

          currentPage = page;
          document.getElementById("loading").style.display = "none";
          document.getElementById("tenantsContainer").style.display = "block";
        } catch (error) {
          console.error("Error loading tenants:", error);
          document.getElementById("loading").innerHTML = `
                    <p style="color: #ef4444;">Failed to load tenants: ${error.message}</p>
                `;
        }
      }

      // Create tenant
      document
        .getElementById("createForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const tenantName = document.getElementById("tenantName").value.trim();
          const createBtn = document.getElementById("createBtn");

          createBtn.disabled = true;
          createBtn.textContent = "Creating...";

          try {
            const response = await fetch(`${API_BASE}/tenants`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name: tenantName }),
            });

            const result = await response.json();

            if (!result.success) {
              throw new Error(result.message);
            }

            showMessage(
              `Tenant "${tenantName}" created successfully!`,
              "success"
            );
            document.getElementById("tenantName").value = "";
            loadTenants(currentPage);
          } catch (error) {
            showMessage(error.message, "error");
          } finally {
            createBtn.disabled = false;
            createBtn.textContent = "Create Tenant";
          }
        });

      // Stop tenant
      async function stopTenant(name) {
        if (!confirm(`Stop tenant "${name}"?`)) return;

        try {
          const response = await fetch(`${API_BASE}/tenants/${name}/stop`, {
            method: "PUT",
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          showMessage(`Tenant "${name}" stopped successfully!`, "success");
          loadTenants(currentPage);
        } catch (error) {
          showMessage(error.message, "error");
        }
      }

      // Start tenant
      async function startTenant(name) {
        try {
          const response = await fetch(`${API_BASE}/tenants/${name}/start`, {
            method: "PUT",
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          showMessage(`Tenant "${name}" started successfully!`, "success");
          loadTenants(currentPage);
        } catch (error) {
          showMessage(error.message, "error");
        }
      }

      // Delete tenant
      async function deleteTenant(name) {
        if (
          !confirm(
            `Delete tenant "${name}"? This will remove all data and cannot be undone!`
          )
        )
          return;

        try {
          const response = await fetch(`${API_BASE}/tenants/${name}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message);
          }

          showMessage(`Tenant "${name}" deleted successfully!`, "success");
          loadTenants(currentPage);
        } catch (error) {
          showMessage(error.message, "error");
        }
      }

      // Load tenants on page load
      loadTenants();

      // Auto-refresh every 30 seconds
      setInterval(() => loadTenants(currentPage), 30000);
    </script>
  </body>
</html>
